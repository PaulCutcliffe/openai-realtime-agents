{
  "id": "product_review_summary",
  "title": "List All Useful Information for Reviewing Products",
  "description": "Retrieves all records from the Product table and displays many useful columns.",
  "database": "Gardlink4",
  "sqlQuery": "DECLARE @EANFilter AS NVARCHAR(MAX)\n--\tSET @EANFilter = '9781405957618, 9780008321246, 9798888500767, 9781398713208, 9781802060263';\t-- Use this line in SSMS when testing\n--\tSET @EANFilter = '9781529160550';\t\t\t\t\t\t\t\t\t\t\t\t-- Use this line in SSMS when testing\n\tSET @EANFilter = '*';\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-- Use this line in SSMS when testing\n--\tSET @EANFilter = '!Criteria1!';\t\t\t\t\t\t\t\t\t\t\t\t-- Use this line in the G4Reporter\n\n\tDECLARE @SupplierFilter AS NVARCHAR(MAX)\n--\tSET @SupplierFilter = 'Gardners Books LTD';                                                               -- Use this line in SSMS when testing\n\tSET @SupplierFilter = '';                                                                       -- Use this line in SSMS when testing\n--\tSET @SupplierFilter = '!Criteria9!';\t\t\t\t\t\t\t\t\t\t\t-- Use this line in the G4Reporter\n\nWITH\n\tTotalSoldEver AS (\n\t\tSELECT \n\t\t\t[SalesLine].[EAN],\n\t\t\tSUM([SalesLine].[Quantity]) AS 'TotalQuantitySoldEver',\n\t\t\tMAX([Sales].[TransactionDate]) AS 'LastSoldDate'\n\t\tFROM \n\t\t\t[Gardlink].[SalesLine]\n\t\tJOIN \n\t\t\t[Gardlink].[Sales] ON [Sales].[TransactionID] = [SalesLine].[TransactionID]\n\t\tWHERE\n\t\t\t[Sales].[DateDeleted] IS NULL\n\t\tGROUP BY \n\t\t\t[SalesLine].[EAN]\n\t),\n\tTotalSold12m AS (\n\t\tSELECT \n\t\t\t[SalesLine].[EAN],\n\t\t\tSUM([SalesLine].[Quantity]) AS 'TotalQuantitySold12m'\n\t\tFROM \n\t\t\t[Gardlink].[SalesLine]\n\t\tJOIN \n\t\t\t[Gardlink].[Sales] ON [Sales].[TransactionID] = [SalesLine].[TransactionID]\n\t\tWHERE\n\t\t\t[Sales].[DateDeleted] IS NULL\n\t\t\tAND [Sales].[TransactionDate] > DATEADD(YEAR, -1, GETDATE())\n\t\tGROUP BY \n\t\t\t[SalesLine].[EAN]\n\t),\n\tLastReturn AS (\n\t\tSELECT \n\t\t\t[OrderLine].[EAN],\n\t\t\tSUM([OrderLine].[Quantity]) AS 'TotalQuantityReturned',\n\t\t\tMAX([ProductOrder].[DateSent]) AS 'LastReturnedDate'\n\t\tFROM\n\t\t\t[Gardlink].[OrderLine]\n\t\tJOIN\n\t\t\t[Gardlink].[ProductOrder] ON [OrderLine].[ProductOrderID] = [ProductOrder].[ProductOrderID]\n\t\tWHERE\n\t\t\t[ProductOrder].[ProductOrderTypeID] = 3\n\t\tGROUP BY\n\t\t\t[OrderLine].[EAN]\n\t),\n\t[EANList] AS (\n\t\tSELECT [value] AS [EAN]\n\t\tFROM STRING_SPLIT(@EANFilter, ',')\n\t\tWHERE RTRIM(LTRIM([value])) <> '*'\n\t)\nSELECT\n\t[Product].[EAN] AS 'EAN',\n\t[Product].[Title] AS 'Title',\n\t[Author].[FullName] AS 'Author',\n\t[Binding].[BindingDescription] AS 'Binding',\n \t[ProductType].[TypeName] AS 'Shop Category',\n    [Product].[PrimaryBic] AS 'BIC Code',\n    ISNULL([BicClassCode].[BicClassDescription], 'Unknown') AS 'BIC Description',\n--\t[Product].[PrimaryBic] + ': ' + ISNULL([BicClassCode].[BicClassDescription], 'Unknown')  AS 'BIC Class',\n\tCONVERT(DECIMAL(18,2), [Product].[RRP]) AS 'RRP',\n\tIIF([Product].[RetailPrice] = 0, NULL, CONVERT(DECIMAL(18,2), [Product].[RetailPrice])) AS 'Shop Price',\n\tCONVERT(DECIMAL(18,2), IIF(ISNULL([Product].[LastPurchaseCost], 0) = 0, [Product].[RRP] * .6, [Product].[LastPurchaseCost])) AS 'Last Cost Price',\n\t[Product].[LocalStockLevel] AS 'Qty In Stock',\n\tISNULL([TotalSoldEver].[TotalQuantitySoldEver], 0) AS 'Total Sales',\n\tISNULL([TotalSold12m].[TotalQuantitySold12m], 0) AS '12m Sales',\n\tCONVERT(DATE, [Product].[PublicationDate]) AS 'Published',\n\tCONVERT(DATE, [Product].[DateCreated]) AS 'First on System',\n\tCONVERT(DATE, [TotalSoldEver].[LastSoldDate]) AS 'Last Sold',\n\tFORMAT(DATEDIFF(DAY, [TotalSoldEver].[LastSoldDate], GETDATE()), 'N0') AS 'Days Since Sold',\n\tCONVERT(DATE, MAX([OrderTransmission].[DateOfAttemptedSend])) AS 'Last Ordered',\n    (\n        SELECT TOP 1 CONVERT(DATE, [GoodsInLine].[Date])\n        FROM [Gardlink].[GoodsInLine]\n        JOIN [Gardlink].[OrderLine] ON [GoodsInLine].[OrderLineID] = [OrderLine].[OrderLineID]\n        WHERE [OrderLine].[EAN] = [Product].[EAN]\n        ORDER BY [GoodsInLine].[Date] DESC, [GoodsInLine].[InvoiceNumber] DESC\n    ) AS 'Last Received',\n    (\n        SELECT TOP 1 FORMAT(DATEDIFF(DAY, [GoodsInLine].[Date], GETDATE()), 'N0')\n        FROM [Gardlink].[GoodsInLine]\n        JOIN [Gardlink].[OrderLine] ON [GoodsInLine].[OrderLineID] = [OrderLine].[OrderLineID]\n        WHERE [OrderLine].[EAN] = [Product].[EAN]\n        ORDER BY [GoodsInLine].[Date] DESC, [GoodsInLine].[InvoiceNumber] DESC\n    ) AS 'Days Since Received',\n    (\n        SELECT TOP 1 [GoodsInLine].[Quantity]\n        FROM [Gardlink].[GoodsInLine]\n        JOIN [Gardlink].[OrderLine] ON [GoodsInLine].[OrderLineID] = [OrderLine].[OrderLineID]\n        WHERE [OrderLine].[EAN] = [Product].[EAN]\n        ORDER BY [GoodsInLine].[Date] DESC, [GoodsInLine].[InvoiceNumber] DESC\n    ) AS 'Last Received Qty',\n    (\n        SELECT TOP 1 [GoodsInLine].[InvoiceNumber]\n        FROM [Gardlink].[GoodsInLine]\n        JOIN [Gardlink].[OrderLine] ON [GoodsInLine].[OrderLineID] = [OrderLine].[OrderLineID]\n        WHERE [OrderLine].[EAN] = [Product].[EAN]\n        ORDER BY [GoodsInLine].[Date] DESC, [GoodsInLine].[InvoiceNumber] DESC\n    ) AS 'Last Inv No',\n    [SupplierDetail].[BusinessName] AS 'Last Supplied By',\n\tCONVERT(DATE, [LastReturn].[LastReturnedDate]) AS 'Last Returned',\n\tFORMAT(DATEDIFF(DAY, [LastReturn].[LastReturnedDate], GETDATE()), 'N0') AS 'Days Since Returned',\n\tISNULL([LastReturn].[TotalQuantityReturned], 0) AS 'Total Returned'\nFROM\n\t[Gardlink].[Product]\n\tLEFT JOIN [TotalSoldEver] ON [Product].[EAN] = TotalSoldEver.[EAN]\n\tLEFT JOIN [TotalSold12m] ON [Product].[EAN] = TotalSold12m.[EAN]\n\tLEFT JOIN [LastReturn] ON [Product].[EAN] = LastReturn.[EAN]\n\tLEFT JOIN [EANList] ON [Product].[EAN] = EANList.[EAN]\n\tLEFT JOIN [Gardlink].[Author] ON [Product].[EAN] = [Author].[EAN]\n\tLEFT JOIN [Gardlink].[Binding] ON [Binding].[BindingID] = [Product].[BindingTypeID]\n\tLEFT JOIN [Gardlink].[ProductType] ON [Product].[ProductTypeID] = [ProductType].[ProductTypeID]\n\tLEFT JOIN [Gardlink].[SupplierDetail] ON [Product].[LastSupplierAccountNumber] = [SupplierDetail].[SupplierAccountNumber]\n\tLEFT JOIN [Gardlink].[OrderLine] ON [OrderLine].[EAN] = [Product].[EAN]\n\tLEFT JOIN [Gardlink].[OrderTransmission] ON [OrderTransmission].[ProductOrderID] = [OrderLine].[ProductOrderID]\n    LEFT JOIN [Gardlink].[BicClassCode] ON [Product].[PrimaryBic] = [BicClassCode].[BicClassCode]\nWHERE\n    (\n        (@EANFilter = '*' AND [Product].[LocalStockLevel] > 0)\n            OR \n        EANList.[EAN] IS NOT NULL\n    )\n    AND\n    (\n        @SupplierFilter = ''\n            OR\n        [SupplierDetail].[BusinessName] = @SupplierFilter\n    )\n    AND [SupplierDetail].[DateDeleted] IS NULL\n    AND [Author].[EntryIndex] = 1\nGROUP BY\n\t[Product].[EAN],\n\t[Product].[LocalStockLevel],\n\t[Product].[Title],\n\t[ProductType].[TypeName],\n\t[Binding].[BindingDescription],\n\t[Author].[FullName],\n\t[Product].[RRP],\n\t[Product].[RetailPrice],\n\t[Product].[LastPurchaseCost],\n\t[Product].[DateCreated],\n\t[SupplierDetail].[BusinessName],\n\t[Product].[PublicationDate],\n    [Product].[PrimaryBic],\n    [BicClassCode].[BicClassDescription],\n\tTotalSoldEver.[TotalQuantitySoldEver],\n\tTotalSold12m.[TotalQuantitySold12m],\n\tTotalSoldEver.[LastSoldDate],\n\tLastReturn.[TotalQuantityReturned],\n\tLastReturn.[LastReturnedDate]\nORDER BY\n\t'Last Received', \n\t'Last Ordered', \n\t'Last Sold', \n\t'First on System', \n\tTotalSoldEver.[TotalQuantitySoldEver] DESC,\n\t[Product].[LocalStockLevel] DESC;",
  "parameters": []
}
